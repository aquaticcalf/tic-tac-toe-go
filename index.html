<!DOCTYPE html>
<html>
<head>
    <title>tic tac toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Finger+Paint&display=swap" rel="stylesheet">
    <style>
      body {
          background-color: #8E7AB5;
          color: #EEA5A6;
          font-family: 'Finger Paint', cursive;
      }

      .box {
          border-right: 2px solid;
          border-bottom: 2px solid;
      }

      .box:nth-child(3n) {
          border-right: none;
      }

      .box:nth-child(6) ~ .box {
          border-bottom: none;
      } 

      #gameboard {
          width: 300px;
          display: flex;
          flex-wrap: wrap;
          margin-top: 40px;
      }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
  <h1 class="text-[54px] uppercase">Tic Tac Toe</h1>
  <div class="status text-center font-bold mt-4" id="status">connecting...</div>
  <div class="board w-96" id="gameboard">
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="0"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="1"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="2"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="3"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="4"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="5"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="6"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="7"></button>
    <button class="cell box h-[100px] w-[100px] text-3xl font-bold cursor-pointer" data-index="8"></button>
  </div>

  <script>
    let socket
    let current_player
    let current_turn
    
    const game_id = new URLSearchParams(window.location.search).get('game') || 
                    Math.random().toString(36).substring(2, 15)
    
    if (!window.location.search.includes('game')) {
      window.history.pushState({}, '', `?game=${game_id}`)
    }

    socket = new WebSocket(`ws://localhost:8080/ws?game=${game_id}`)

    socket.onopen = () => {
      document.getElementById('status').textContent = 'connected! waiting for opponent...'
    }

    socket.onmessage = (event) => {
      const message = JSON.parse(event.data)
      
      switch (message.type) {
        case 'init':
          current_player = message.player
          current_turn = message.turn
          update_board(message.board)
          update_status()
          break
          
        case 'update':
          current_turn = message.turn
          update_board(message.board)
          update_status()
          break
          
        case 'gameover':
          update_board(message.board)
          document.getElementById('status').textContent = 
              message.player === current_player ? 'you won!' : 'you lost!'
          break
      }
    }

    socket.onclose = () => {
      document.getElementById('status').textContent = 'disconnected'
    }

    document.querySelectorAll('.cell').forEach(cell => {
      cell.addEventListener('click', () => {
        if (current_turn === current_player) {
          const position = parseInt(cell.dataset.index)
          socket.send(JSON.stringify({
            type: 'move',
            position: position
          }))
        }
      })
    })

    function update_board(board) {
      document.querySelectorAll('.cell').forEach((cell, index) => {
        cell.textContent = board[index]
      })
    }

    function update_status() {
      const status = document.getElementById('status')
      if (current_turn === current_player) {
        status.textContent = 'your turn!'
      } else {
        status.textContent = "opponent's turn"
      }
    }

    document.getElementById('status').innerHTML += '<br>share this link to play: ' + 
      `<a href="${window.location.href}">${window.location.href}</a>`
  </script>
</body>
</html>